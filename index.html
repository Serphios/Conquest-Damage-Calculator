<!DOCTYPE html>
<html>
<head>
  <title>Conquest Damage Calculator</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 30px auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 30px;
      max-width: 1200px;
      width: 100%;
    }
    .section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 20px;
    }
    .section-title {
      width: 100%;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }
    .input-group {
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
    }
    label {
      margin-top: 10px;
    }
    input, select, button {
      padding: 8px;
      margin-top: 5px;
    }
    .result {
      margin-top: 30px;
      font-weight: bold;
      white-space: pre-line;
      max-width: 1000px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Conquest Damage Calculator</h1>
  <div class="container">
    <div class="section">
      <div class="section-title">Your Unit</div>
      <div class="input-group">
        <label>Total Stands:</label>
        <input type="number" id="models" value="3">
        <label>Stands in Contact:</label>
        <input type="number" id="standsInContact" value="3">
		<label>Support (for non-contact stands):</label>
        <input type="number" id="support" value="1">
        <label>Attacks per Stand:</label>
        <input type="number" id="attacks" value="4">
        <label>Impact Attacks per Stand:</label>
        <input type="number" id="impact" value="0">
        <label>Clash Value:</label>
        <input type="number" id="cllash" value="3">
        <label>Cleave:</label>
        <input type="number" id="cleave" value="0">
        <label>Brutal Impact:</label>
        <input type="number" id="brutalImpact" value="0">
        <label>Trample (per Stand):</label>
        <input type="number" id="trample" value="0">
		<label>Terrifying:</label>
        <input type="number" id="terrifying" value="0">
        <label><input type="checkbox" id="leader" checked> Add Leader (1 extra attack)</label>
        <label><input type="checkbox" id="inspired"> Inspired (Clash +1, max 4)</label>
        <label><input type="checkbox" id="attackerBlessed"> Blessed (reroll all hit rolls)</label>
        <label>Attacker Blessed Usage:</label>
        <select id="attackerBlessedUsage">
          <option value="none">None</option>
          <option value="normal">Normal Attack</option>
          <option value="impact">Impact Attack</option>
        </select>
        <label><input type="checkbox" id="flurry"> Flurry (reroll all hit rolls)</label>
        <label><input type="checkbox" id="opportunists"> Opportunists (reroll all hit rolls if Flank/Rear)</label>
        <label><input type="checkbox" id="flawless"> Flawless Strikes (Rolls of 1 ignore defense)</label>
		<label><input type="checkbox" id="deadlyBlades"> Deadly Blades (Defense rolls of 6 cause 2 wounds + 2 resolve checks)</label>
		<label><input type="checkbox" id="gloriousCharge"> Glorious Charge (+1 Clash & Terrifying 1 for Impact Attacks)</label>
		<label><input type="checkbox" id="linebreaker"> Linebreaker (Ignores Shield and Bastion)</label>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Opponent Unit</div>
      <div class="input-group">
		<label>Total Stands (Defender):</label>
	    <input type="number" id="defenderStands" value="3">
        <label>Defense Value:</label>
        <input type="number" id="defense" value="2">
        <label>Evasion Value:</label>
        <input type="number" id="evasion" value="0">
        <label>Resolve Value:</label>
        <input type="number" id="resolve" value="2">
		<label>Hardened:</label>
		<input type="number" id="hardened" value="0">
		<label>Indomitable:</label>
	    <input type="number" id="indomitable" value="0">
		<label>Bastion:</label>
	    <input type="number" id="bastion" value="0">
        <label>Flank or Rear Attack:</label>
        <input type="checkbox" id="flankRear">
        <label>Ignore Resolve:</label>
        <input type="checkbox" id="ignoreResolve">
		<label><input type="checkbox" id="shield"> Shield (+1 Defense unless Flank/Rear)</label>
        <label><input type="checkbox" id="duelDeclined"> Duel Declined (reroll resolve rolls of 1)</label>
        <label>Defender Blessed Usage:</label>
        <select id="defenderBlessed">
          <option value="none">None</option>
          <option value="normal">Normal Attack</option>
          <option value="impact">Impact Attack</option>
        </select>
		<label>Bravery / Fearless:</label>
<select id="bravery">
  <option value="none">None</option>
  <option value="bravery">Bravery</option>
  <option value="fearless">Fearless</option>
</select>
      </div>
    </div>
    <div class="section">
      <button onclick="calculateDamage()">Calculate Damage</button>
    </div>
    <div class="result" id="result"></div>
  </div>

  <script>
    function calculateDamage() {
      const models = +document.getElementById('models').value;
      const attacks = +document.getElementById('attacks').value;
      const impact = +document.getElementById('impact').value;
      const clash = +document.getElementById('cllash').value;
      const cleave = +document.getElementById('cleave').value;
      const brutalImpact = +document.getElementById('brutalImpact').value;
      const trample = +document.getElementById('trample').value;
	  const deadlyBlades = document.getElementById('deadlyBlades').checked;
      const defense = +document.getElementById('defense').value;
      const evasion = +document.getElementById('evasion').value;
      const resolve = +document.getElementById('resolve').value;
	  const hardened = +document.getElementById('hardened').value;
	  const defenderStands = +document.getElementById('defenderStands').value;
	  const indomitable = +document.getElementById('indomitable').value;
	  const gloriousCharge = document.getElementById('gloriousCharge').checked;
	  const shield = document.getElementById('shield').checked;
	  const bastion = +document.getElementById('bastion').value;
	  const linebreaker = document.getElementById('linebreaker').checked;

		let resolveBonus = 0;
		if (defenderStands >= 4 && defenderStands <= 6) {
		resolveBonus = 1;
		} else if (defenderStands >= 7 && defenderStands <= 9) {
		resolveBonus = 2;
		} else if (defenderStands >= 10) {
		resolveBonus = 3;
		}

	  const effectiveResolve = resolve + resolveBonus;
      const terrifying = +document.getElementById('terrifying').value;
	  const braveryType = document.getElementById('bravery').value;
	  const ignoreTerrifying = braveryType === 'bravery' || braveryType === 'fearless';
      const flankRear = document.getElementById('flankRear').checked;
      const ignoreResolve = document.getElementById('ignoreResolve').checked;
      const duelDeclined = document.getElementById('duelDeclined').checked;
      const blessedUsage = document.getElementById('defenderBlessed').value;

      const leader = document.getElementById('leader').checked;
      const inspired = document.getElementById('inspired').checked;
      const attackerBlessed = document.getElementById('attackerBlessed').checked;
      const attackerBlessedUsage = document.getElementById('attackerBlessedUsage').value;
      const flurry = document.getElementById('flurry').checked;
      const opportunists = document.getElementById('opportunists').checked;
      const flawless = document.getElementById('flawless').checked;

      const support = +document.getElementById('support').value;
	  const standsInContact = Math.min(models, +document.getElementById('standsInContact').value);
	  const nonContactStands = models - standsInContact;
	  let totalAttacks = 0;
	  if (attacks > 0) {
	  totalAttacks = standsInContact * attacks + nonContactStands * support + (leader ? 1 : 0);
	  }
      let clashValue = inspired ? Math.min(clash + 1, 4) : clash;
      const rerollSixes = inspired && clash + 1 > 4;
      const baseHitChance = clashValue / 6;

      let hits = totalAttacks * baseHitChance;
      if (rerollSixes) hits += totalAttacks * (1 / 6) * baseHitChance;
      if ((attackerBlessed && attackerBlessedUsage === 'normal') || flurry || (opportunists && flankRear)) {
        hits += totalAttacks * (1 - baseHitChance) * baseHitChance;
      }

      const totalImpact = models * impact;
      let clashImpact = clash;
	  if (gloriousCharge) clashImpact += 1;
	  const impactHitChance = clashImpact / 6;
      let impactHits = totalImpact * impactHitChance;
      if ((attackerBlessed && attackerBlessedUsage === 'impact') || flurry || (opportunists && flankRear)) {
        impactHits += totalImpact * (1 - impactHitChance) * impactHitChance;
      }
	  let effectiveDefense = defense;

	  if (!linebreaker) {
	  effectiveDefense += bastion;
	  if (shield && !flankRear) {
	  effectiveDefense += 1;
	  }
	  }
      const reducedCleave = Math.max(0, cleave - hardened);
	  const reducedBrutalImpact = Math.max(0, brutalImpact - hardened);

	  const saveNormal = Math.max(effectiveDefense - reducedCleave, evasion);
	  const saveImpact = Math.max(effectiveDefense - reducedBrutalImpact, evasion);
      const saveTrample = Math.max(effectiveDefense, evasion);

      let saveChanceNormal = Math.min(saveNormal, 6) / 6;
      let saveChanceImpact = Math.min(saveImpact, 6) / 6;
      let saveChanceTrample = Math.min(saveTrample, 6) / 6;

      if (blessedUsage === 'normal') saveChanceNormal += (1 - saveChanceNormal) * saveChanceNormal;
      if (blessedUsage === 'impact') saveChanceImpact += (1 - saveChanceImpact) * saveChanceImpact;

      const totalTerrifying = terrifying + (gloriousCharge ? 1 : 0);
	  const resolveVal = Math.max(1, effectiveResolve - (ignoreTerrifying ? 0 : totalTerrifying));
      let resolveChance = ignoreResolve ? 1 : Math.min(resolveVal, 5) / 6;
      if (duelDeclined && !ignoreResolve) resolveChance -= (1 / 6) * (1 / 6);

      const flawlessHits = flawless ? totalAttacks * (1 / 6) : 0;
      const regularHits = hits - flawlessHits;

      const saveFlawless = Math.max(evasion, 0);
      const saveChanceFlawless = Math.min(saveFlawless, 6) / 6;

	  const failedSavesFlawless = flawlessHits * (1 - saveChanceFlawless);
      let failedResolveFlawless = failedSavesFlawless * (1 - resolveChance);
	  if (flankRear && !ignoreResolve) {
	  failedResolveFlawless += failedSavesFlawless * resolveChance * (1 - resolveChance);
	  }
	  failedResolveFlawless = Math.max(0, failedResolveFlawless - indomitable);

	  let baseFailedSaves = regularHits * (1 - saveChanceNormal);
	  let deadlyHits = 0;
	  let failedSaves = baseFailedSaves;

	  if (deadlyBlades) {
	  deadlyHits = baseFailedSaves * (1 / 6); // 6er unter den Fehlwürfen
	  failedSaves = deadlyHits * 2 + (baseFailedSaves - deadlyHits); // 2 Wunden für 6er, 1 für Rest
	  }

	  let failedResolve = failedSaves * (1 - resolveChance);
	  if (flankRear && !ignoreResolve) {
	  failedResolve += failedSaves * resolveChance * (1 - resolveChance);
	  }
	  failedResolve = Math.max(0, failedResolve - indomitable);

      const failedImpactSaves = impactHits * (1 - saveChanceImpact);
      let failedImpactResolve = failedImpactSaves * (1 - resolveChance);
	  if (flankRear && !ignoreResolve) {
	  failedImpactResolve += failedImpactSaves * resolveChance * (1 - resolveChance);
	  }
	  failedImpactResolve = Math.max(0, failedImpactResolve - indomitable);

      const trampleHits = models * trample;
      const trampleWounds = trampleHits * (1 - saveChanceTrample);

      const totalWoundsNormal = failedSaves + failedResolve + failedSavesFlawless + failedResolveFlawless;
      const totalWoundsImpact = failedImpactSaves + failedImpactResolve;
      const totalWounds = totalWoundsNormal + totalWoundsImpact + trampleWounds;

      let resultText = '';
      if (totalAttacks > 0) {
        resultText += `--- Normal Attack ---\n` +
                      `Hits: ${(regularHits + flawlessHits).toFixed(1)}\n` +
                      `Failed Saves: ${(failedSaves + failedSavesFlawless).toFixed(1)}${blessedUsage === 'normal' ? ' (Defender Blessed)' : ''}${attackerBlessed && attackerBlessedUsage === 'normal' ? ' (Attacker Blessed)' : ''}${flawless ? ' (Flawless Strikes)' : ''}\n` +
                      `Failed Resolve: ${(failedResolve + failedResolveFlawless).toFixed(1)}\n` +
                      `Wounds: ${totalWoundsNormal.toFixed(1)}\n\n`;
      }
      if (totalImpact > 0) {
        resultText += `--- Impact Attack ---\n` +
                      `Hits: ${impactHits.toFixed(1)}\n` +
                      `Failed Saves: ${failedImpactSaves.toFixed(1)}${blessedUsage === 'impact' ? ' (Defender Blessed)' : ''}${attackerBlessed && attackerBlessedUsage === 'impact' ? ' (Attacker Blessed)' : ''}\n` +
                      `Failed Resolve: ${failedImpactResolve.toFixed(1)}\n` +
                      `Wounds: ${totalWoundsImpact.toFixed(1)}\n\n`;
      }
      if (trampleHits > 0) {
        resultText += `--- Trample ---\n` +
                      `Auto-Hits (from ${models} stands): ${trampleHits}\n` +
                      `Failed Saves: ${(trampleWounds).toFixed(1)}\n` +
                      `Wounds: ${trampleWounds.toFixed(1)}\n\n`;
      }

      resultText += `--- Total Damage ---\n` +
                    `Overall Wounds: ${totalWounds.toFixed(1)}`;

      document.getElementById('result').innerText = resultText;
    }
  </script>
</body>
</html>
